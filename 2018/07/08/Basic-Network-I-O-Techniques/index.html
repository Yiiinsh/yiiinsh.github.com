<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Basic Network I/O Techniques | Yiiin</title>
  
    <link rel="icon" href="/assets/avatar.jpeg">
  
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url()">
        <div class='av-pic' style="background-image: url(/assets/avatar.jpeg)">
        </div>
    </section>
    <section class='menu'>
        <div>Yiiin</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
            
                <a href="https://github.com/Yiiins">
                    <img src="/assets/github.svg" />
                </a>
            
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>Basic Network I/O Techniques</h1>
    </header>

    <section>
      <p>经常能在各种地方看到这么一句话：</p>
<blockquote>
<p>Everything in Unix is a file</p>
</blockquote>
<p>当Unix程序做任何的I/O时，本质上他们也是通过读/写相应的文件的描述符（file descriptor)来进行操作。</p>
<p>在Unix系统中，文件描述符是一个泛化的概念，它是一个代表了某个打开的‘文件’的一个整型值(integer)。此处的‘文件’既可以是一个字面意义上存储在磁盘上的一个数据文件，也可以是一个网络通信，一个FIFO，一个Pipe…等。</p>
<p>本文中，我将研究一下基本的C语言下的Network I/O。<br><a id="more"></a></p>
<p>Socket是系统中一种使用文件描述符来与其它程序进行通信的方式。 通常来说，我们会使用Socket来进行网络中传输层的数据传输，即使用TCP或者UDP协议，来进行网络的通信。</p>
<p>要通过网络进行数据传输，不管是否需要进行连接，我们都至少需要知晓对应的数据接收方的地址。网络环境下，我们需要使用对应的IP来路由到对应接受程序所在的主机（Host）地址，而后再使用端口（Port）来定位到对应的程序。当下的环境中，我们存在IPv4与IPv6等不同的IP协议版本，或者我们可能使用不同的协议（protocol）进行通信，因此，我们需要通过一些通信元数据的配置，来获得我们需要的Socket，从而使用Socket来进行网络通信。</p>
<p>总体说来，使用Socket进行数据通信有着如下的基本流程：</p>
<ul>
<li>获得对应的用来告诉Socket地址信息的元数据 struct addrinfo </li>
<li>使用上一步获得的地址信息，创建一个可用的Socket</li>
<li>如果是一个服务端应用<ul>
<li>当前的Socket，通常是使用本机的地址信息进行创建的</li>
<li>使用bind将该程序绑定到系统可用的某个端口，使其它网络程序可以访问</li>
<li>使用listen来声明我们将在当前主机的对应端口来进行监听</li>
<li>我们可以调用一个阻塞的accept操作，一直到有其他方connect到我们监听的端口，此时会产生一个用来描述这个新连接的socket file descriptor</li>
<li>通过这个新连接得到的socketfd，使用send/recv进行通信（如果使用无连接UDP，则使用对应的sendto/recvfrom操作）</li>
</ul>
</li>
<li>如果是一个客户端应用<ul>
<li>当前的Socket，通常是使用目标服务地址信息进行创建的</li>
<li>使用connect进行到服务端的连接</li>
<li>通过这个新连接得到的socketfd，使用send/recv进行通信（如果使用无连接UDP，则使用对应的sendto/recvfrom操作）</li>
</ul>
</li>
<li>使用close或者shutdown关闭创立的Socket连接</li>
</ul>
<h2 id="struct-addrinfo"><a href="#struct-addrinfo" class="headerlink" title="struct addrinfo"></a>struct addrinfo</h2><p>网络通信，需要知晓通信方对应的地址，再通过创建对应的Socket来建立连接，进行通信。struct addrinfo就是对应的用来告诉Socket地址信息的元数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span>              ai_flags;     <span class="comment">// AI_PASSIVE, AI_CANONNAME, etc.</span></span><br><span class="line">	<span class="keyword">int</span>              ai_family;    <span class="comment">// AF_INET, AF_INET6, AF_UNSPEC</span></span><br><span class="line">	<span class="keyword">int</span>              ai_socktype;  <span class="comment">// SOCK_STREAM, SOCK_DGRAM</span></span><br><span class="line">	<span class="keyword">int</span>              ai_protocol;  <span class="comment">// use 0 for "any"</span></span><br><span class="line">	<span class="keyword">size_t</span>           ai_addrlen;   <span class="comment">// size of ai_addr in bytes</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *<span class="title">ai_addr</span>;</span>      <span class="comment">// struct sockaddr_in or _in6</span></span><br><span class="line">	<span class="keyword">char</span>            *ai_canonname; <span class="comment">// full canonical hostname</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">ai_next</span>;</span>      <span class="comment">// linked list, next node</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构体里，我们可以指定对应的IP协议（IPv4 or IPv6），socket的类型（TPC or UDP），以及其它地址相关的信息。我们需要通过填入对应的元信息,再使用这个addrinfo来进行Socket的创建。当然，我们不需要手动的进行填写，我们可以使用getaddrinfo函数来进行数据的填充：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getaddrinfo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *node,     <span class="comment">// e.g. "www.example.com" or IP</span></span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> <span class="keyword">char</span> *service,  <span class="comment">// e.g. "http" or port number</span></span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> struct addrinfo *hints, <span class="comment">// pointer to a addrinfo that you have already fill out with relevant information</span></span></span></span><br><span class="line"><span class="function"><span class="params">                struct addrinfo **res)</span></span>; <span class="comment">// pointer to a linked-list of getaddrinfo results</span></span><br></pre></td></tr></table></figure>
<p>例如，我们可以用如下方式来获得一个绑定本机IP以及特定PORT的addrinfo：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> status;</span><br><span class="line"><span class="keyword">char</span> *MYPORT=<span class="string">"6666"</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints); <span class="comment">// make sure the struct is empty</span></span><br><span class="line">hints.ai_family = AF_UNSPEC;	 <span class="comment">// IPv4 or IPv6</span></span><br><span class="line">hints.ai_socktype = SOCK_STREAM; <span class="comment">// TCP</span></span><br><span class="line">hints.ai_flags = AI_PASSIVE;	 <span class="comment">// fill in local IP</span></span><br><span class="line"><span class="keyword">if</span> ((status = getaddrinfo(<span class="literal">NULL</span>, MYPORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(status));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者，获得对应一个网络端的addrinfo：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> status;</span><br><span class="line"><span class="keyword">char</span> *IP=<span class="string">"www.example.com"</span>;</span><br><span class="line"><span class="keyword">char</span> *PORT=<span class="string">"6666"</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints); <span class="comment">// make sure the struct is empty</span></span><br><span class="line">hints.ai_family = AF_UNSPEC;	 <span class="comment">// IPv4 or IPv6</span></span><br><span class="line">hints.ai_socktype = SOCK_STREAM; <span class="comment">// TCP</span></span><br><span class="line"><span class="keyword">if</span> ((status = getaddrinfo(IP, PORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(status));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上的操作，我们将获得res，即上例的servinfo， 这是一个addrinfo的链表。我们需要遍历这个链表来找到一个可用的信息来创建Socket。需要注意的是，对于锁获得的res，即上述的servinfo，我们需要调用 freeaddrinfo(servinfo) 来清理对应的数据。</p>
<p>在获得对应的信息后，我们就可以依据上述流程，创建对应的Socket，我们将得到一个socketfd。之后，我们就可以对socketfd这个文件描述符进行相应的网络I/O操作。需要注意的是，对于每一步操作，都需要检验其返回值，来检查操作是否成功的执行或者资源是否可用。</p>
<h2 id="Demo-TCP-Server"><a href="#Demo-TCP-Server" class="headerlink" title="Demo TCP Server"></a>Demo TCP Server</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Stream socket server demo</span></span><br><span class="line"><span class="comment"> * Usage: telnet localhost 3490</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPORT <span class="meta-string">"3490"</span>  <span class="comment">// the port clinets will be connecting to</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 5	  <span class="comment">// how many pending connections queue will hold</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_FLAG 0 <span class="comment">// default sent/recv flag</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get socket addr, IPv4 or IPv6</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">get_in_addr</span><span class="params">(struct sockaddr *sa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (sa-&gt;sa_family == AF_INET)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;(((struct sockaddr_in *)sa)-&gt;sin_addr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;(((struct sockaddr_in6 *)sa)-&gt;sin6_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sockfd, new_fd;					  <span class="comment">// listen on sockfd, new connection on new_fd</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>, *<span class="title">p</span>;</span> <span class="comment">// server info &amp; iter pointer</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">client_addr</span>;</span>  <span class="comment">// connector's address information</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addr_size;				  <span class="comment">// length of connecting socket</span></span><br><span class="line">	<span class="keyword">int</span> status;							  <span class="comment">// status for checking</span></span><br><span class="line">	<span class="keyword">int</span> yes = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">char</span> s[INET6_ADDRSTRLEN];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. load up local address info</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints); <span class="comment">// make sure the struct is empty</span></span><br><span class="line">	hints.ai_family = AF_UNSPEC;	 <span class="comment">// IPv4 or IPv6</span></span><br><span class="line">	hints.ai_socktype = SOCK_STREAM; <span class="comment">// TCP</span></span><br><span class="line">	hints.ai_flags = AI_PASSIVE;	 <span class="comment">// fill in local IP</span></span><br><span class="line">	<span class="keyword">if</span> ((status = getaddrinfo(<span class="literal">NULL</span>, MYPORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(status));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. loop through results list and bind to the first we can</span></span><br><span class="line">	<span class="keyword">for</span> (p = servinfo; p != <span class="literal">NULL</span>; p = p-&gt;ai_next)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 2.1. create an available socket</span></span><br><span class="line">		<span class="keyword">if</span> ((sockfd = socket(p-&gt;ai_family, p-&gt;ai_socktype, p-&gt;ai_protocol)) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">"server: socket"</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2.2 set sock opt</span></span><br><span class="line">		<span class="keyword">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;yes, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">"setsockopt"</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2.3. bind socket to port</span></span><br><span class="line">		<span class="keyword">if</span> (bind(sockfd, p-&gt;ai_addr, p-&gt;ai_addrlen) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			close(sockfd);</span><br><span class="line">			perror(<span class="string">"server: bind"</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	freeaddrinfo(servinfo); <span class="comment">// clean up memory</span></span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"server: failed to bind\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. listen</span></span><br><span class="line">	<span class="keyword">if</span> (listen(sockfd, BACKLOG) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">"listen"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"Waiting for connection...\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4. accept incoming messages</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 4.1. accept new connection</span></span><br><span class="line">		addr_size = <span class="keyword">sizeof</span> client_addr;</span><br><span class="line">		<span class="keyword">if</span> ((new_fd = accept(sockfd, (struct sockaddr *)&amp;client_addr, &amp;addr_size)) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">"accept"</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.2. get client address</span></span><br><span class="line">		inet_ntop(client_addr.ss_family, get_in_addr((struct sockaddr *)&amp;client_addr), s, <span class="keyword">sizeof</span> s);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"server: got connection from %s\n"</span>, s);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.3. fork new process to handle, exit after processing</span></span><br><span class="line">		<span class="keyword">if</span> (!fork()) <span class="comment">// child process</span></span><br><span class="line">		&#123;</span><br><span class="line">			close(sockfd); <span class="comment">// child doesn't need the listener</span></span><br><span class="line">			<span class="comment">// communicate via send/recv (for unconnected UDP, use sendto, recvfrom)</span></span><br><span class="line">			<span class="keyword">if</span> (send(new_fd, <span class="string">"Hello World!"</span>, <span class="number">13</span>, DEFAULT_FLAG) == <span class="number">-1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				perror(<span class="string">"send"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			close(new_fd);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		close(new_fd); <span class="comment">// parent doesn't need new_fd; if want to customize, use int shutdown(int sockfd, int how)</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Demo-TCP-Client"><a href="#Demo-TCP-Client" class="headerlink" title="Demo TCP Client"></a>Demo TCP Client</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Stream socket client demo</span></span><br><span class="line"><span class="comment"> * Usage: ./client localhost</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT <span class="meta-string">"3490"</span>		<span class="comment">// the port clinets will be connecting to</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXDATASIZE 100 <span class="comment">// max number of bytes we can get at once</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_FLAG 0  <span class="comment">// default sent/recv flag</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get sockaddr, IPv4 or IPv6:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">get_in_addr</span><span class="params">(struct sockaddr *sa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (sa-&gt;sa_family == AF_INET)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;(((struct sockaddr_in *)sa)-&gt;sin_addr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;(((struct sockaddr_in6 *)sa)-&gt;sin6_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sockfd, numbytes;				  <span class="comment">// socket file descriptor</span></span><br><span class="line">	<span class="keyword">char</span> buf[MAXDATASIZE];				  <span class="comment">// buf for data recv</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>, *<span class="title">servinfo</span>, *<span class="title">p</span>;</span> <span class="comment">// server info &amp; iter pointer</span></span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">char</span> s[INET6_ADDRSTRLEN];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: client hostname\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. load up server address info</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span> hints); <span class="comment">// make sure the struct is empty</span></span><br><span class="line">	hints.ai_family = AF_UNSPEC;	 <span class="comment">// IPv4 or IPv6</span></span><br><span class="line">	hints.ai_socktype = SOCK_STREAM; <span class="comment">// TCP</span></span><br><span class="line">	<span class="keyword">if</span> ((status = getaddrinfo(argv[<span class="number">1</span>], PORT, &amp;hints, &amp;servinfo)) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"getaddrinfo: %s\n"</span>, gai_strerror(status));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. loop through results list and bind to the first we can</span></span><br><span class="line">	<span class="keyword">for</span> (p = servinfo; p != <span class="literal">NULL</span>; p = p-&gt;ai_next)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 2.1. create an available socket</span></span><br><span class="line">		<span class="keyword">if</span> ((sockfd = socket(p-&gt;ai_family, p-&gt;ai_socktype, p-&gt;ai_protocol)) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">"client: socket"</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2.2. connect</span></span><br><span class="line">		<span class="keyword">if</span> (connect(sockfd, p-&gt;ai_addr, p-&gt;ai_addrlen) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			close(sockfd);</span><br><span class="line">			perror(<span class="string">"client: connect"</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"client: failed to connect\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	inet_ntop(p-&gt;ai_family, get_in_addr((struct sockaddr *)p-&gt;ai_addr), s, <span class="keyword">sizeof</span> s);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"client: connecting to %s\n"</span>, s);</span><br><span class="line">	freeaddrinfo(servinfo); <span class="comment">// clean up memory</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. recv message from server</span></span><br><span class="line">	<span class="keyword">if</span> ((numbytes = recv(sockfd, buf, MAXDATASIZE - <span class="number">1</span>, DEFAULT_FLAG)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">"recv"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	buf[numbytes] = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"client: received '%s'\n"</span>, buf);</span><br><span class="line">	close(sockfd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>Ref. <a href="http://beej.us/guide/bgnet/html/single/bgnet.html#intro" target="_blank" rel="noopener">Beej’s Guide to Network Programming</a></p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2018-07-08T07:58:53.000Z" itemprop="datePublished">
              2018-07-08
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/C/">C</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/I-O/">I/O</a> }
  </li>


            </div>
          
      </section>
    
    
</article>

  
</div>

            <footer>
    <div>© 2018 - Yin </div>
    <div>
        <span>
            Powered by <a href="https://hexo.io">Hexo</a>
        </span>
        ,
        <span>
            Theme - <a href="https://github.com/nameoverflow/hexo-theme-icalm">Icalm</a>
        </span>
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>